<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<div layout:fragment="content">
    <div class="max-w-4xl mx-auto" x-data="attendanceClock()">
        <!-- Page Header -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Attendance</h1>
            <p class="text-sm text-gray-500">Clock in dan clock out untuk mencatat kehadiran kerja Anda</p>
        </div>

        <!-- Today's Date & Time -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 mb-6">
            <div class="text-center">
                <p class="text-sm text-gray-500 mb-1" x-text="formatDate(new Date())"></p>
                <h2 class="text-4xl font-bold text-gray-900" x-text="formatTime(new Date())"></h2>
            </div>
        </div>

        <!-- Today's Shift Info -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6" x-show="shift">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Shift Hari Ini</h3>
            </div>
            <div class="p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium"
                              :class="{
                                  'bg-blue-50 text-blue-700': shift?.shiftName,
                                  'bg-gray-100 text-gray-700': !shift?.shiftName
                              }">
                            <span class="w-2 h-2 rounded-full" :style="shift?.shiftColor ? 'background-color: ' + shift.shiftColor : ''"></span>
                            <span x-text="shift?.shiftName || 'Tidak ada shift'"></span>
                        </span>
                        <span x-show="shift?.isWfhAllowed" class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-green-50 text-green-700">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.306a11.95 11.95 0 015.814-5.518l2.74-1.22m0 0l-5.94-2.281m5.94 2.281l-2.28 5.941" />
                            </svg>
                            WFH Allowed
                        </span>
                        <span x-show="!shift?.isWfhAllowed" class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-amber-50 text-amber-700">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                            </svg>
                            WFO Only
                        </span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <span x-show="shift?.shiftStartTime" x-text="shift?.shiftStartTime"></span>
                        <span x-show="shift?.shiftStartTime && shift?.shiftEndTime"> - </span>
                        <span x-show="shift?.shiftEndTime" x-text="shift?.shiftEndTime"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Validation Warning -->
        <div x-show="isPastShiftEnd" class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-red-600 mt-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                <div class="flex-1">
                    <p class="text-sm font-medium text-red-900">Waktu Shift Berakhir</p>
                    <p class="text-xs text-red-700 mt-1" x-text="timeValidationMessage"></p>
                    <p class="text-xs text-red-600 mt-1">Clock-in tidak tersedia. Silakan hubungi admin jika ada kebutuhan khusus.</p>
                </div>
            </div>
        </div>

        <!-- Clock In/Out Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-6">
                <!-- Status Badge -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-700">Status Hari Ini:</span>
                        <span th:if="${todayAttendance == null}" class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
                            <span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span>
                            Belum Clock In
                        </span>
                        <span th:if="${todayAttendance != null and todayAttendance.clockOutTime == null}" class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700">
                            <span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
                            Sudah Clock In
                        </span>
                        <span th:if="${todayAttendance != null and todayAttendance.clockOutTime != null}" class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-green-50 text-green-700">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                            Selesai
                        </span>
                    </div>
                    <a th:href="@{/attendance/history}" class="text-sm text-blue-600 hover:text-blue-700 font-medium">Riwayat &rarr;</a>
                </div>

                <!-- Today's Attendance Details -->
                <div th:if="${todayAttendance != null}" class="bg-gray-50 rounded-xl p-4 mb-6">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500 mb-1">Clock In</p>
                            <p class="font-semibold text-gray-900" th:text="${todayAttendance.clockInTime != null ? todayAttendance.clockInTime : '-'}">-</p>
                        </div>
                        <div>
                            <p class="text-gray-500 mb-1">Clock Out</p>
                            <p class="font-semibold text-gray-900" th:text="${todayAttendance.clockOutTime != null ? todayAttendance.clockOutTime : '-'}">-</p>
                        </div>
                    </div>
                    <div th:if="${todayAttendance.isLate}" class="mt-3 pt-3 border-t border-gray-200">
                        <div class="flex items-center gap-2 text-amber-600">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008h-.008v-.008z" />
                            </svg>
                            <span class="text-sm font-medium">Terlambat <span th:text="${todayAttendance.lateDurationMinutes}">0</span> menit</span>
                        </div>
                    </div>
                </div>

                <!-- Clock In Button -->
                <button th:if="${todayAttendance == null}"
                        @click="clockIn"
                        :disabled="loading || !canClockIn"
                        class="w-full py-4 rounded-xl text-lg font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        :class="{
                            'bg-blue-600 border border-blue-600 text-white hover:bg-blue-700': canClockIn,
                            'bg-gray-400 border border-gray-400 text-white cursor-not-allowed': !canClockIn
                        }">
                    <span x-show="!loading" class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Clock In Sekarang
                    </span>
                    <span x-show="loading">Memproses...</span>
                </button>

                <!-- Clock Out Button -->
                <button th:if="${todayAttendance != null and todayAttendance.clockOutTime == null}"
                        @click="clockOut"
                        :disabled="loading"
                        class="w-full py-4 bg-red-600 border border-red-600 rounded-xl text-lg font-semibold text-white hover:bg-red-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!loading" class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15" />
                        </svg>
                        Clock Out Sekarang
                    </span>
                    <span x-show="loading">Memproses...</span>
                </button>

                <!-- Completed Message -->
                <div th:if="${todayAttendance != null and todayAttendance.clockOutTime != null}"
                     class="w-full py-4 bg-green-50 border border-green-200 rounded-xl text-center">
                    <div class="flex items-center justify-center gap-2 text-green-700 font-medium">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Absensi Hari Ini Selesai</span>
                    </div>
                </div>
            </div>

            <!-- Location Info -->
            <div class="px-6 pb-6">
                <!-- Location Validation Status -->
                <div class="rounded-xl p-4"
                     :class="{
                         'bg-green-50': locationStatus === 'valid',
                         'bg-red-50': locationStatus === 'invalid',
                         'bg-blue-50': locationStatus === 'detecting' || locationStatus === 'unknown'
                     }">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 mt-0.5"
                             :class="{
                                 'text-green-600': locationStatus === 'valid',
                                 'text-red-600': locationStatus === 'invalid',
                                 'text-blue-600': locationStatus === 'detecting' || locationStatus === 'unknown'
                             }"
                             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                        </svg>
                        <div class="flex-1">
                            <p class="text-sm font-medium"
                               :class="{
                                   'text-green-900': locationStatus === 'valid',
                                   'text-red-900': locationStatus === 'invalid',
                                   'text-blue-900': locationStatus === 'detecting' || locationStatus === 'unknown'
                               }">Lokasi Anda</p>
                            <p class="text-xs mt-1"
                               :class="{
                                   'text-green-700': locationStatus === 'valid',
                                   'text-red-700': locationStatus === 'invalid',
                                   'text-blue-700': locationStatus === 'detecting' || locationStatus === 'unknown'
                               }"
                               id="location-status" x-text="locationMessage"></p>
                            <!-- Distance info -->
                            <p x-show="distance !== null" class="text-xs mt-1"
                               :class="{
                                   'text-green-600': locationStatus === 'valid',
                                   'text-red-600': locationStatus === 'invalid',
                                   'text-blue-600': locationStatus === 'detecting' || locationStatus === 'unknown'
                               }">
                                Jarak ke kantor: <span x-text="Math.round(distance)"></span> meter
                                <span x-show="maxRadius !== null" x-text="'(maks: ' + maxRadius + 'm)'"></span>
                            </p>
                        </div>
                        <!-- Status icon -->
                        <div x-show="locationStatus === 'valid'" class="flex-shrink-0">
                            <svg class="w-6 h-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div x-show="locationStatus === 'invalid'" class="flex-shrink-0">
                            <svg class="w-6 h-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008h-.008v-.008z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- WFH Required Message -->
                <div x-show="shift?.isWfhAllowed && !hasApprovedWfh" class="mt-3 bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-amber-600 mt-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-amber-900">WFH Approval Required</p>
                            <p class="text-xs text-amber-700 mt-1">Shift Anda mengizinkan WFH. Anda memerlukan persetujuan WFH untuk clock in. Silakan ajukan permintaan WFH terlebih dahulu.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Summary -->
        <div th:if="${todayAttendance != null and todayAttendance.clockOutTime != null}" class="mt-6 bg-white rounded-xl p-6 shadow-sm border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Ringkasan Hari Ini</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-xl p-4 text-center">
                    <p class="text-2xl font-bold text-gray-900" th:text="${todayAttendance.actualWorkMinutes != null ? todayAttendance.actualWorkMinutes / 60 : 0}">0</p>
                    <p class="text-xs text-gray-500">Jam Kerja</p>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 text-center" th:if="${todayAttendance.isOvertime}">
                    <p class="text-2xl font-bold text-amber-600" th:text="${todayAttendance.overtimeDurationMinutes != null ? todayAttendance.overtimeDurationMinutes / 60 : 0}">0</p>
                    <p class="text-xs text-gray-500">Jam Lembur</p>
                </div>
            </div>
        </div>
    </div>

    <script>
    function attendanceClock() {
        return {
            loading: false,
            location: null,
            shift: null,
            company: null,
            locationStatus: 'detecting', // detecting, unknown, valid, invalid
            locationMessage: 'Mendeteksi lokasi...',
            distance: null,
            maxRadius: null,
            hasApprovedWfh: false,
            canClockIn: false,
            isPastShiftEnd: false,
            timeValidationMessage: null,

            init() {
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);
                // Also validate time every minute
                setInterval(() => this.validateShiftTime(), 60000);
                this.loadSettings();
            },

            updateTime() {
                const now = new Date();
                const el = document.getElementById('currentTime');
                if (el) el.textContent = this.formatTime(now);
            },

            formatTime(date) {
                return date.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },

            formatDate(date) {
                return date.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            },

            async loadSettings() {
                try {
                    const response = await fetch('/attendance/api/today-settings');
                    const data = await response.json();

                    console.log('API Response:', data);

                    if (data.success) {
                        this.shift = data;
                        this.maxRadius = data.maxRadius || 100;
                        console.log('Shift data:', this.shift);
                        console.log('Office lat:', data.officeLatitude, 'lng:', data.officeLongitude);
                        this.validateShiftTime();
                        this.getLocation();
                    } else {
                        this.locationStatus = 'unknown';
                        this.locationMessage = data.message || 'Gagal memuat pengaturan';
                    }
                } catch (e) {
                    console.error('Error loading settings:', e);
                    this.locationStatus = 'unknown';
                    this.locationMessage = 'Gagal memuat pengaturan: ' + e.message;
                }
            },

            async getLocation() {
                if (!navigator.geolocation) {
                    this.locationStatus = 'unknown';
                    this.locationMessage = 'Geolocation tidak didukung browser ini';
                    return;
                }

                this.locationStatus = 'detecting';
                this.locationMessage = 'Mendeteksi lokasi...';
                this.canClockIn = false;

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        this.validateLocation();
                    },
                    (error) => {
                        this.locationStatus = 'unknown';
                        this.locationMessage = 'Gagal mendapatkan lokasi: ' + error.message;
                        this.canClockIn = false;
                    }
                );
            },

            validateLocation() {
                console.log('validateLocation called');
                console.log('Location:', this.location);
                console.log('Shift:', this.shift);
                console.log('Office lat:', this.shift?.officeLatitude, 'lng:', this.shift?.officeLongitude);

                if (!this.location) {
                    this.locationStatus = 'unknown';
                    this.locationMessage = 'Lokasi tidak tersedia';
                    this.canClockIn = false;
                    return;
                }

                // Check if shift allows WFH
                if (this.shift?.isWfhAllowed) {
                    // For WFH shifts, location validation is not required
                    // But need to check if has approved WFH request
                    this.locationStatus = 'valid';
                    this.locationMessage = 'Lokasi terdeteksi. Shift mengizinkan WFH.';
                    // Only set canClockIn to true if not past shift end
                    if (!this.isPastShiftEnd) {
                        this.canClockIn = true;
                    } else {
                        this.canClockIn = false;
                    }
                    return;
                }

                // For non-WFH shifts, validate location against office
                // Check if office location is set (not null, not undefined, not empty string)
                const officeLat = this.shift?.officeLatitude;
                const officeLng = this.shift?.officeLongitude;

                console.log('Office lat check:', officeLat, 'type:', typeof officeLat);
                console.log('Office lng check:', officeLng, 'type:', typeof officeLng);

                if (!officeLat || !officeLng || officeLat === 'null' || officeLng === 'null') {
                    this.locationStatus = 'unknown';
                    this.locationMessage = 'Lokasi kantor belum diatur. Silakan hubungi admin.';
                    this.canClockIn = false;
                    return;
                }

                // Parse as float in case they are strings
                const lat = parseFloat(officeLat);
                const lng = parseFloat(officeLng);

                console.log('Parsed lat:', lat, 'lng:', lng);

                // Calculate distance
                this.distance = this.calculateDistance(
                    this.location.latitude,
                    this.location.longitude,
                    lat,
                    lng
                );

                const maxRadius = this.maxRadius || 100;

                console.log('Distance:', this.distance, 'maxRadius:', maxRadius);

                if (this.distance <= maxRadius) {
                    this.locationStatus = 'valid';
                    this.locationMessage = 'Lokasi valid. Anda berada dalam radius kantor.';
                    // Only set canClockIn to true if not past shift end
                    if (!this.isPastShiftEnd) {
                        this.canClockIn = true;
                    } else {
                        this.canClockIn = false;
                    }
                } else {
                    this.locationStatus = 'invalid';
                    this.locationMessage = 'Lokasi tidak valid. Anda di luar radius kantor.';
                    this.canClockIn = false;
                }
            },

            // Haversine formula to calculate distance between two coordinates
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Earth radius in meters
                const phi1 = lat1 * Math.PI / 180;
                const phi2 = lat2 * Math.PI / 180;
                const deltaPhi = (lat2 - lat1) * Math.PI / 180;
                const deltaLambda = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                        Math.cos(phi1) * Math.cos(phi2) *
                        Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                return R * c;
            },

            // Validate if current time is within shift hours
            validateShiftTime() {
                if (!this.shift?.shiftEndTime) {
                    this.isPastShiftEnd = false;
                    this.timeValidationMessage = null;
                    this.updateCanClockIn();
                    return;
                }

                const now = new Date();
                const currentTime = now.toTimeString().slice(0, 8); // HH:MM:SS format
                const shiftEndTime = this.shift.shiftEndTime; // Already in HH:MM format

                console.log('Current time:', currentTime, 'Shift end:', shiftEndTime);

                // Compare times
                if (currentTime >= shiftEndTime) {
                    this.isPastShiftEnd = true;
                    this.timeValidationMessage = `Waktu sudah melewati jam shift keluar (${shiftEndTime})`;
                    console.log('Past shift end time');
                } else {
                    this.isPastShiftEnd = false;
                    this.timeValidationMessage = null;
                    console.log('Within shift hours');
                }

                this.updateCanClockIn();
            },

            // Update canClockIn based on all validations
            updateCanClockIn() {
                if (this.isPastShiftEnd) {
                    this.canClockIn = false;
                    return;
                }
                // Location validation will set canClockIn to true/false
                // If we're here and not past shift end, defer to location validation
            },

            async clockIn() {
                if (this.loading) return;
                if (!this.canClockIn) {
                    if (this.isPastShiftEnd) {
                        alert('Tidak dapat clock in. ' + this.timeValidationMessage);
                    } else {
                        alert('Tidak dapat clock in. ' + this.locationMessage);
                    }
                    return;
                }

                this.loading = true;

                try {
                    const response = await fetch('/attendance/api/clock-in', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            employeeId: [[${employee.id}]],
                            clockInDateTime: new Date().toISOString(),
                            latitude: this.location?.latitude || 0,
                            longitude: this.location?.longitude || 0,
                            deviceInfo: navigator.userAgent
                        })
                    });

                    if (response.ok) {
                        window.location.reload();
                    } else {
                        const text = await response.text();
                        try {
                            const error = JSON.parse(text);
                            alert(error.message || 'Gagal clock in');
                        } catch {
                            alert('Gagal clock in: ' + text);
                        }
                    }
                } catch (e) {
                    alert('Terjadi kesalahan: ' + e.message);
                } finally {
                    this.loading = false;
                }
            },

            async clockOut() {
                if (this.loading) return;
                this.loading = true;

                try {
                    const response = await fetch('/attendance/api/clock-out', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            employeeId: [[${employee.id}]],
                            clockOutDateTime: new Date().toISOString(),
                            latitude: this.location?.latitude || 0,
                            longitude: this.location?.longitude || 0,
                            deviceInfo: navigator.userAgent
                        })
                    });

                    if (response.ok) {
                        window.location.reload();
                    } else {
                        const text = await response.text();
                        try {
                            const error = JSON.parse(text);
                            alert(error.message || 'Gagal clock out');
                        } catch {
                            alert('Gagal clock out: ' + text);
                        }
                    }
                } catch (e) {
                    alert('Terjadi kesalahan: ' + e.message);
                } finally {
                    this.loading = false;
                }
            }
        };
    }
    </script>
</div>
</html>
